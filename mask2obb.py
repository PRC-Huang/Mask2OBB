from shapely.geometry import MultiPoint
from shapely.affinity import rotate
import math
import numpy as np


def mask2obb(points):
    obj = MultiPoint(points)
    convex_hull = obj.convex_hull
    rotating_center = convex_hull.centroid
    convex_hull_points = convex_hull.exterior.coords
    min_area = None
    mbr = None
    mbr_angle = None

    for i in range(len(convex_hull_points) - 2):
        point_a = convex_hull_points[i]
        point_b = convex_hull_points[i + 1]

        opposite = point_b[1] - point_a[1]
        adjacent = point_b[0] - point_a[0]

        if adjacent == 0:
            angle = math.pi / 2
        else:
            angle = math.atan(opposite / float(adjacent))

        obj_rotated = rotate(convex_hull, -angle, origin=rotating_center,
                             use_radians=True)

        if min_area is None or obj_rotated.envelope.area < min_area:
            min_area = obj_rotated.envelope.area
            mbr = obj_rotated.envelope
            mbr_angle = angle

    # rotate back
    mbr = rotate(mbr, mbr_angle, origin=rotating_center, use_radians=True)

    # return rectangle vertices coordinates
    return list(mbr.exterior.coords), mbr_angle*180/math.pi


if __name__ == '__main__':
    segm = [[83, 114, 82, 115, 81, 115, 80, 115, 79, 115, 78, 115, 77, 115, 76, 116, 75, 117, 74, 118, 73, 119, 72, 120, 71, 121, 70, 122, 69, 123, 68, 124, 68, 125, 67, 126, 67, 127, 66, 128, 66, 129, 65, 130, 64, 131, 64, 132, 63, 133, 63, 134, 62, 135, 61, 136, 61, 137, 60, 138, 60, 139, 59, 140, 59, 141, 58, 142, 57, 143, 57, 144, 56, 145, 56, 146, 55, 147, 55, 148, 55, 149, 55, 150, 55, 151, 55, 152, 54, 153, 54, 154, 54, 155, 54, 156, 54, 157, 54, 158, 55, 159, 55, 160, 56, 161, 56, 162, 57, 163, 57, 164, 58, 165, 58, 166, 59, 167, 59, 168, 60, 169, 61, 170, 62, 171, 63, 172, 64, 173, 65, 174, 66, 175, 67, 176, 68, 177, 69, 178, 70, 179, 71, 180, 71, 181, 72, 182, 73, 183, 74, 184, 75, 185, 76, 186, 77, 187, 78, 188, 79, 189, 80, 190, 81, 191, 82, 192, 83, 193, 84, 193, 85, 194, 86, 195, 87, 196, 88, 197, 89, 197, 90, 198, 91, 199, 92, 200, 93, 200, 94, 201, 95, 202, 96, 203, 97, 203, 98, 204, 99, 205, 100, 206, 101, 207, 102, 207, 103, 208, 104, 209, 105, 209, 106, 210, 107, 211, 108, 211, 109, 212, 110, 213, 111, 213, 112, 214, 113, 215, 114, 215, 115, 216, 116, 217, 117, 217, 118, 218, 119, 219, 120, 219, 121, 220, 122, 221, 123, 221, 124, 222, 125, 223, 126, 223, 127, 224, 128, 224, 129, 225, 130, 225, 131, 226, 132, 226, 133, 227, 134, 227, 135, 228, 136, 228, 137, 229, 138, 229, 139, 230, 140, 231, 141, 231, 142, 232, 143, 232, 144, 233, 145, 233, 146, 234, 147, 234, 148, 235, 149, 235, 150, 236, 151, 236, 152, 237, 153, 237, 154, 238, 155, 238, 156, 239, 157, 239, 158, 240, 159, 240, 160, 241, 161, 241, 162, 242, 163, 242, 164, 243, 165, 243, 166, 244, 167, 245, 168, 245, 169, 246, 170, 246, 171, 247, 172, 247, 173, 248, 174, 248, 175, 249, 176, 249, 177, 250, 178, 250, 179, 251, 180, 251, 181, 252, 182, 252, 183, 253, 184, 253, 185, 254, 186, 254, 187, 255, 188, 255, 189, 256, 190, 256, 191, 257, 192, 257, 193, 258, 194, 259, 195, 259, 196, 260, 197, 260, 198, 261, 199, 261, 200, 262, 201, 262, 202, 263, 203, 263, 204, 264, 205, 264, 206, 265, 207, 265, 208, 266, 209, 266, 210, 267, 211, 267, 212, 268, 213, 268, 214, 269, 215, 269, 216, 270, 217, 270, 218, 271, 219, 271, 220, 272, 221, 272, 222, 273, 223, 274, 224, 274, 225, 275, 226, 275, 227, 276, 228, 276, 229, 277, 230, 277, 231, 278, 232, 278, 233, 279, 234, 279, 235, 280, 236, 280, 237, 281, 238, 281, 239, 282, 240, 282, 241, 283, 242, 283, 243, 284, 244, 284, 245, 285, 246, 285, 247, 286, 248, 286, 249, 287, 250, 288, 251, 288, 252, 289, 253, 289, 254, 290, 255, 290, 256, 291, 257, 291, 258, 292, 259, 292, 260, 293, 261, 293, 262, 294, 263, 294, 264, 295, 265, 295, 266, 296, 267, 296, 268, 297, 269, 297, 270, 298, 271, 298, 272, 299, 273, 299, 274, 300, 275, 300, 276, 301, 277, 301, 278, 302, 279, 303, 280, 303, 281, 304, 282, 304, 283, 305, 284, 305, 285, 306, 286, 306, 287, 307, 288, 307, 289, 308, 290, 308, 291, 309, 292, 309, 293, 310, 294, 310, 295, 311, 296, 311, 297, 312, 298, 312, 299, 313, 300, 313, 301, 314, 302, 314, 303, 315, 304, 315, 305, 316, 306, 317, 307, 317, 308, 318, 309, 318, 310, 319, 311, 319, 312, 320, 313, 320, 314, 321, 315, 321, 316, 322, 317, 322, 318, 323, 319, 323, 320, 324, 321, 324, 322, 325, 323, 325, 324, 326, 325, 326, 326, 327, 327, 327, 328, 328, 329, 328, 330, 329, 331, 329, 332, 330, 333, 331, 334, 331, 335, 332, 336, 332, 337, 333, 338, 333, 339, 334, 340, 334, 341, 335, 342, 335, 343, 336, 344, 336, 345, 337, 346, 337, 347, 338, 348, 338, 349, 339, 350, 339, 351, 340, 352, 340, 353, 341, 354, 341, 355, 342, 356, 342, 357, 343, 358, 343, 359, 344, 360, 344, 361, 345, 362, 346, 363, 346, 364, 347, 365, 347, 366, 348, 367, 348, 368, 349, 369, 349, 370, 350, 371, 350, 372, 351, 373, 351, 374, 352, 375, 352, 376, 353, 377, 353, 378, 354, 379, 354, 380, 355, 381, 355, 382, 356, 383, 356, 384, 357, 385, 357, 386, 358, 387, 358, 388, 359, 389, 360, 390, 360, 391, 361, 392, 361, 393, 362, 394, 362, 395, 363, 396, 363, 397, 364, 398, 364, 399, 365, 400, 365, 401, 366, 402, 366, 403, 367, 404, 367, 405, 368, 406, 368, 407, 369, 408, 369, 409, 370, 410, 370, 411, 371, 412, 371, 413, 372, 414, 372, 415, 373, 416, 373, 417, 374, 418, 375, 419, 375, 420, 376, 421, 376, 422, 377, 423, 377, 424, 378, 425, 378, 426, 379, 427, 379, 428, 380, 429, 380, 430, 381, 431, 381, 432, 382, 433, 382, 434, 383, 435, 383, 436, 384, 437, 384, 438, 385, 439, 385, 440, 386, 441, 386, 442, 387, 443, 387, 444, 388, 445, 389, 446, 389, 447, 390, 448, 390, 449, 391, 450, 391, 451, 392, 452, 392, 453, 393, 454, 393, 455, 394, 456, 394, 457, 395, 458, 395, 459, 396, 460, 396, 461, 397, 462, 397, 463, 398, 464, 398, 465, 399, 466, 399, 467, 400, 468, 400, 469, 401, 470, 401, 471, 402, 472, 403, 473, 403, 474, 404, 475, 404, 476, 405, 477, 405, 478, 406, 479, 406, 480, 407, 481, 407, 482, 408, 483, 408, 484, 409, 485, 409, 486, 410, 487, 410, 488, 410, 489, 411, 490, 411, 491, 411, 492, 412, 493, 412, 494, 413, 495, 413, 496, 413, 497, 414, 498, 414, 499, 414, 500, 414, 501, 414, 502, 414, 503, 414, 504, 414, 505, 414, 506, 414, 507, 414, 508, 414, 509, 414, 510, 414, 511, 415, 512, 415, 513, 415, 514, 415, 515, 415, 516, 415, 517, 415, 518, 415, 519, 415, 520, 415, 521, 415, 522, 415, 523, 415, 524, 415, 525, 415, 526, 415, 527, 415, 528, 415, 529, 415, 530, 415, 531, 415, 532, 415, 533, 415, 534, 416, 535, 415, 536, 415, 537, 415, 538, 415, 539, 415, 540, 415, 541, 415, 542, 415, 543, 415, 544, 415, 545, 415, 546, 415, 547, 415, 548, 415, 549, 415, 550, 415, 551, 415, 552, 415, 553, 415, 554, 415, 555, 415, 556, 415, 557, 415, 558, 415, 559, 414, 560, 414, 561, 414, 562, 413, 563, 413, 564, 413, 565, 412, 566, 412, 567, 412, 568, 411, 569, 411, 570, 411, 571, 410, 572, 409, 573, 408, 574, 407, 575, 406, 576, 405, 577, 404, 577, 403, 577, 402, 577, 401, 577, 400, 577, 399, 577, 398, 577, 397, 577, 396, 577, 395, 577, 394, 577, 393, 577, 392, 577, 391, 576, 390, 576, 389, 575, 388, 575, 387, 574, 386, 574, 385, 574, 384, 573, 383, 573, 382, 572, 381, 572, 380, 572, 379, 571, 378, 571, 377, 570, 376, 570, 375, 569, 374, 569, 373, 568, 372, 568, 371, 567, 370, 566, 369, 565, 368, 565, 367, 564, 366, 563, 365, 562, 364, 562, 363, 561, 362, 560, 361, 559, 360, 559, 359, 558, 358, 557, 357, 556, 356, 556, 355, 555, 354, 554, 353, 553, 352, 553, 351, 552, 350, 551, 349, 550, 348, 550, 347, 549, 346, 548, 345, 547, 344, 547, 343, 546, 342, 545, 341, 544, 340, 543, 339, 542, 338, 541, 337, 540, 336, 539, 336, 538, 335, 537, 334, 536, 333, 535, 332, 534, 331, 533, 330, 532, 329, 531, 329, 530, 328, 529, 328, 528, 327, 527, 327, 526, 326, 525, 326, 524, 325, 523, 324, 522, 324, 521, 323, 520, 323, 519, 322, 518, 322, 517, 321, 516, 321, 515, 320, 514, 320, 513, 319, 512, 319, 511, 318, 510, 318, 509, 317, 508, 317, 507, 316, 506, 315, 505, 315, 504, 314, 503, 314, 502, 313, 501, 313, 500, 312, 499, 312, 498, 311, 497, 311, 496, 310, 495, 310, 494, 309, 493, 309, 492, 308, 491, 308, 490, 307, 489, 306, 488, 306, 487, 305, 486, 305, 485, 304, 484, 304, 483, 303, 482, 303, 481, 302, 480, 302, 479, 301, 478, 301, 477, 300, 476, 300, 475, 299, 474, 299, 473, 298, 472, 297, 471, 297, 470, 296, 469, 296, 468, 295, 467, 295, 466, 294, 465, 294, 464, 293, 463, 293, 462, 292, 461, 292, 460, 291, 459, 291, 458, 290, 457, 290, 456, 289, 455, 288, 454, 288, 453, 287, 452, 287, 451, 286, 450, 286, 449, 285, 448, 285, 447, 284, 446, 284, 445, 283, 444, 283, 443, 282, 442, 282, 441, 281, 440, 281, 439, 280, 438, 280, 437, 279, 436, 278, 435, 278, 434, 277, 433, 277, 432, 276, 431, 276, 430, 275, 429, 275, 428, 274, 427, 274, 426, 273, 425, 273, 424, 272, 423, 272, 422, 271, 421, 271, 420, 270, 419, 269, 418, 269, 417, 268, 416, 268, 415, 267, 414, 267, 413, 266, 412, 266, 411, 265, 410, 265, 409, 264, 408, 264, 407, 263, 406, 263, 405, 262, 404, 262, 403, 261, 402, 260, 401, 260, 400, 259, 399, 259, 398, 258, 397, 258, 396, 257, 395, 257, 394, 256, 393, 256, 392, 255, 391, 255, 390, 254, 389, 254, 388, 253, 387, 253, 386, 252, 385, 251, 384, 251, 383, 250, 382, 250, 381, 249, 380, 249, 379, 248, 378, 248, 377, 247, 376, 247, 375, 246, 374, 246, 373, 245, 372, 245, 371, 244, 370, 244, 369, 243, 368, 242, 367, 242, 366, 241, 365, 241, 364, 240, 363, 240, 362, 239, 361, 239, 360, 238, 359, 238, 358, 237, 357, 237, 356, 236, 355, 236, 354, 235, 353, 235, 352, 234, 351, 233, 350, 233, 349, 232, 348, 232, 347, 231, 346, 231, 345, 230, 344, 230, 343, 229, 342, 229, 341, 228, 340, 228, 339, 227, 338, 227, 337, 226, 336, 226, 335, 225, 334, 224, 333, 224, 332, 223, 331, 223, 330, 222, 329, 222, 328, 221, 327, 221, 326, 220, 325, 220, 324, 219, 323, 219, 322, 218, 321, 218, 320, 217, 319, 217, 318, 216, 317, 215, 316, 215, 315, 214, 314, 214, 313, 213, 312, 213, 311, 212, 310, 212, 309, 211, 308, 211, 307, 210, 306, 210, 305, 209, 304, 209, 303, 208, 302, 208, 301, 207, 300, 206, 299, 206, 298, 205, 297, 205, 296, 204, 295, 204, 294, 203, 293, 203, 292, 202, 291, 202, 290, 201, 289, 201, 288, 200, 287, 200, 286, 199, 285, 199, 284, 198, 283, 197, 282, 197, 281, 196, 280, 196, 279, 195, 278, 195, 277, 194, 276, 194, 275, 193, 274, 193, 273, 192, 272, 192, 271, 191, 270, 191, 269, 190, 268, 190, 267, 189, 266, 188, 265, 188, 264, 187, 263, 187, 262, 186, 261, 186, 260, 185, 259, 185, 258, 184, 257, 184, 256, 183, 255, 183, 254, 182, 253, 182, 252, 181, 251, 181, 250, 180, 249, 180, 248, 179, 247, 178, 246, 178, 245, 177, 244, 177, 243, 176, 242, 176, 241, 175, 240, 175, 239, 174, 238, 174, 237, 173, 236, 173, 235, 172, 234, 172, 233, 171, 232, 171, 231, 170, 230, 169, 229, 169, 228, 168, 227, 168, 226, 167, 225, 167, 224, 166, 223, 166, 222, 165, 221, 165, 220, 164, 219, 164, 218, 163, 217, 163, 216, 162, 215, 162, 214, 161, 213, 160, 212, 160, 211, 159, 210, 159, 209, 158, 208, 158, 207, 157, 206, 157, 205, 156, 204, 156, 203, 155, 202, 155, 201, 154, 200, 154, 199, 153, 198, 153, 197, 152, 196, 151, 195, 151, 194, 150, 193, 150, 192, 149, 191, 149, 190, 148, 189, 148, 188, 147, 187, 147, 186, 146, 185, 146, 184, 145, 183, 145, 182, 144, 181, 144, 180, 143, 179, 142, 178, 142, 177, 141, 176, 141, 175, 140, 174, 140, 173, 139, 172, 139, 171, 138, 170, 138, 169, 137, 168, 137, 167, 136, 166, 136, 165, 135, 164, 135, 163, 134, 162, 133, 161, 133, 160, 132, 159, 132, 158, 131, 157, 131, 156, 130, 155, 130, 154, 129, 153, 129, 152, 128, 151, 128, 150, 128, 149, 127, 148, 127, 147, 126, 146, 126, 145, 126, 144, 125, 143, 125, 142, 124, 141, 124, 140, 123, 139, 123, 138, 123, 137, 122, 136, 122, 135, 121, 134, 121, 133, 121, 132, 120, 131, 120, 130, 119, 129, 119, 128, 119, 127, 119, 126, 119, 125, 119, 124, 118, 123, 118, 122, 118, 121, 118, 120, 118, 119, 118, 118, 118, 117, 117, 116, 117, 115, 117, 114, 117, 113, 117, 112, 117, 111, 116, 110, 116, 109, 116, 108, 116, 107, 116, 106, 116, 105, 116, 104, 116, 103, 116, 102, 115, 101, 115, 100, 115, 99, 115, 98, 115, 97, 115, 96, 115, 95, 115, 94, 115, 93, 114, 92, 114, 91, 114, 90, 114, 89, 114, 88, 114, 87, 114, 86, 114, 85, 114, 84, 114]]
    x,y = segm[0][::2], segm[0][1::2]
    mask = np.vstack((x,y)).T
    # import matplotlib.pyplot as plt
    # plt.scatter(x, y)
    # plt.show()
    # mask = [(1, 2), (2, 6), (3, 7), (2, 2)]
    obb, direction = mask2obb(mask)
    print(obb, direction)
